<!DOCTYPE html>
<html>

<head>
    <title>P2P</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="icon" href="files/favicon.ico" type="image/png">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <div style="margin-left: 10px;">
            <h1 style="margin-bottom: 0;">Chat 2.1</h1>
            <p style="color: white; margin-top: 0;">Name pending btw lol<br>file sending doesnt work right now</p>
        </div>

        <div class="setup-container" id="setupPanel">
            <h3>User Setup</h3>
            <input type="text" id="usernameInput" placeholder="Enter a display name">
            <input type="password" id="passwordInput" placeholder="Set a password (optional)">
            <button onclick="setUsername()">Save Profile</button>
            <a href="#" onclick="showHelp(); return false;">Help</a>
            <iframe id="helpFrame" style="display: none; width: 100%; height: 200px; border: 1px solid #ddd;"
                src="hewlPwease.txt"></iframe>
        </div>

        <script>
            function showHelp() {
                const helpFrame = document.getElementById("helpFrame");
                helpFrame.style.display = helpFrame.style.display === "none" ? "block" : "none";

                if (helpFrame.style.display === "block") {
                    helpFrame.onload = function () {
                        const doc = helpFrame.contentDocument || helpFrame.contentWindow.document;
                        const style = doc.createElement("style");
                        style.textContent = "body { background-color: #fff; color: #000; font-family: Arial, sans-serif; padding: 10px; }";
                        doc.head.appendChild(style);
                    };
                }
            }
        </script>

        <div id="mainPanel" style="display: none;">
            <div>
                <h3>Your ID: <span id="myId">Generating...</span>
                    <button onclick="copyIdToClipboard()" style="margin-left: 10px;">Copy</button>
                </h3>
                <h3>Your Username: <span id="displayUsername"></span></h3>
                <div id="status" class="connection-status disconnected">Not connected</div>
            </div>

            <script>
                function copyIdToClipboard() {
                    const idText = document.getElementById("myId").innerText;
                    navigator.clipboard.writeText(idText).then(() => {
                        alert("ID copied to clipboard!");
                    }).catch(err => {
                        console.error("Failed to copy ID: ", err);
                    });
                }

                document.addEventListener("DOMContentLoaded", generateId);
            </script>

            <div class="contact-list">
                <h3>Saved Contacts</h3>
                <div id="savedContacts"></div>
            </div>

            <div>
                <h3>Connect to a peer:</h3>
                <input type="text" id="peerIdInput" placeholder="Enter peer ID">
                <button onclick="connectToPeer()">Connect</button>
            </div>

            <div id="messageArea"></div>

            <div class="message-input-container">
                <input type="text" id="messageInput" placeholder="Type your message">
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="sendMessage()">
                <button onclick="openFileManager()">üìÅ</button>
                <button onclick="sendMessage()">Send</button>
            </div>

            <div>
                <h4>Debug Log:</h4>
                <div id="debugArea"></div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let myId;
        let peer = null;
        let conn = null;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        let username = '';
        let password = '';
        let encryptionKey = '';

        function displayMessage(username, message) {
            const messageArea = document.getElementById('messageArea');
            const timestamp = new Date().toLocaleTimeString();
            messageArea.innerHTML += `
                <div class="message received">
                    <strong>${username}:</strong> ${message}
                    <div class="timestamp">${timestamp}</div>
                </div>
            `;
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function openFileManager() {
            document.getElementById('fileInput').click();
        }

        // User keystroke inputs
        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle Enter key in username input
        document.getElementById('usernameInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                setUsername();
            }
        });

        // Handle Enter key in peer ID input
        document.getElementById('peerIdInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                connectToPeer();
            }
        });
    </script>

    <!-- Links to all js files in order -->     
    <script>
        const jsFiles = ['userSetUp.js', 'connections.js', 'messageSending.js', 'encryption.js', 'contacts.js', 'logs.js', 'errorHandling.js'];
        jsFiles.forEach(file => {
            const script = document.createElement('script');
            script.src = `js/${file}`;
            document.head.appendChild(script);
        });
    </script>
</body>

</html>
